<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>History</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #f7f9fc;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,0,0,0.05);
    }

    #back-button {
      display: inline-block;
      margin-bottom: 20px;
      background-color: #4CAF50;
      color: #fff;
      padding: 10px 18px;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    #back-button:hover {
      background-color: #388e3c;
    }

    header h1 {
      font-size: 2.2rem;
      color: #2e7d32;
      text-align: center;
      margin-bottom: 30px;
    }

    label {
      font-weight: bold;
      margin-right: 10px;
    }

    select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: auto;
    }

    .accordion-item {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }

    .accordion-header {
      padding: 14px 20px;
      background-color: #e8f5e9;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      color: #1b5e20;
      border-bottom: 1px solid #c8e6c9;
    }

    .accordion-body {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s ease-in-out;
    }

    .accordion-body.open {
      display: block;
    }

    .summary-card {
      background-color: #fefefe;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 16px;
      padding: 15px;
    }

    .summary-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .summary-card p {
      font-size: 0.95rem;
      margin: 6px 0;
    }

    .timestamp {
      font-size: 0.8rem;
      color: #888;
      text-align: right;
    }

    .readmore {
      color: #1e88e5;
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 5px;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
  </style>
</head>
<body>
  <div class="container">
    <a id="back-button" href="/">← Back to Home</a>
    <header>
      <h1>History</h1>
    </header>

    <div style="margin-bottom: 25px;">
      <label for="summary-dropdown">Choose Summary Group:</label>
      <select id="summary-dropdown">
        <option value="all">Show All</option>
      </select>
    </div>

    <div id="accordion-container">
      <p>Loading summaries...</p>
    </div>
  </div>

  <script>
    function getNumericTimestamp(ts) {
      if (!ts) return 0;
      if (typeof ts === 'object' && ts.seconds) {
        return ts.seconds * 1000;
      }
      const parsed = Date.parse(ts);
      return isNaN(parsed) ? 0 : parsed;
    }

    function createExpandableSummary(fullText) {
      const threshold = 160;
      const container = document.createElement('div');
      let isExpanded = false;

      const paragraph = document.createElement('p');
      const toggle = document.createElement('span');
      toggle.className = 'readmore';

      function updateText() {
        if (isExpanded) {
          paragraph.textContent = fullText;
          toggle.textContent = 'Read Less';
        } else {
          if (fullText.length > threshold) {
            paragraph.textContent = fullText.slice(0, threshold) + '...';
            toggle.textContent = 'Read More';
          } else {
            paragraph.textContent = fullText;
            toggle.textContent = '';
          }
        }

        container.innerHTML = '';
        container.appendChild(paragraph);
        if (toggle.textContent) {
          container.appendChild(toggle);
        }
      }

      toggle.addEventListener('click', () => {
        isExpanded = !isExpanded;
        updateText();
      });

      updateText();
      return container;
    }

    let groupedSummaries = [];

    function populateDropdown(groups) {
      const dropdown = document.getElementById("summary-dropdown");
      dropdown.innerHTML = `<option value="all">Show All</option>`;
      groups.forEach(group => {
        const option = document.createElement("option");
        option.value = group.groupKey;
        option.textContent = group.groupKey;
        dropdown.appendChild(option);
      });

      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        displayAccordion(groupedSummaries, selected, true);
      });
    }

    function displayAccordion(groupArray, selectedGroup = "all", expandSingle = false) {
      const container = document.getElementById("accordion-container");
      container.innerHTML = "";

      const visibleGroups = selectedGroup === "all"
        ? groupArray
        : groupArray.filter(group => group.groupKey === selectedGroup);

      if (visibleGroups.length === 0) {
        container.innerHTML = "<p>No summaries found for the selected group.</p>";
        return;
      }

      visibleGroups.forEach((group, index) => {
        const item = document.createElement("div");
        item.className = "accordion-item";

        const header = document.createElement("div");
        header.className = "accordion-header";
        header.textContent = `Summary for ${group.groupKey}`;
        item.appendChild(header);

        const body = document.createElement("div");
        body.className = "accordion-body";

        group.docs.forEach(doc => {
          const card = document.createElement("div");
          card.className = "summary-card";

          if (doc.model) {
            const h3 = document.createElement("h3");
            h3.textContent = `Model: ${doc.model}`;
            card.appendChild(h3);
          }

          if (doc.summary) {
            const h3 = document.createElement("h3");
            h3.textContent = "Summary";
            card.appendChild(h3);
            card.appendChild(createExpandableSummary(doc.summary));
          }

          if (doc.custom_prompt) {
            const p = document.createElement("p");
            p.innerHTML = `<strong>Prompt:</strong> ${doc.custom_prompt}`;
            card.appendChild(p);
          }

          if (doc.feedback) {
            const p = document.createElement("p");
            p.innerHTML = `<strong>Feedback:</strong> ${doc.feedback}`;
            card.appendChild(p);
          }

          if (doc.comment) {
            const p = document.createElement("p");
            p.innerHTML = `<strong>Comment:</strong> ${doc.comment}`;
            card.appendChild(p);
          }

          if (doc.feedback_timestamp) {
            const p = document.createElement("p");
            const time = getNumericTimestamp(doc.feedback_timestamp);
            p.innerHTML = `<strong>Feedback Time:</strong> ${new Date(time).toLocaleString()}`;
            card.appendChild(p);
          }

          if (doc.timestamp) {
            const ts = document.createElement("div");
            ts.className = "timestamp";
            const time = getNumericTimestamp(doc.timestamp);
            ts.innerHTML = `<strong>Created:</strong> ${new Date(time).toLocaleString()}`;
            card.appendChild(ts);
          }

          body.appendChild(card);
        });

        // Append the accordion parts
        item.appendChild(body);
        container.appendChild(item);

        // If user selected this group → auto expand
        if (expandSingle || selectedGroup !== "all") {
          body.classList.add("open");
        }

        // Add toggle behavior
        header.addEventListener("click", () => {
          body.classList.toggle("open");
        });
      });
    }

    async function fetchSummaries() {
      try {
        const res = await fetch("/summaries");
        const data = await res.json();

        if (!data.summaries || data.summaries.length === 0) {
          document.getElementById("accordion-container").innerHTML = "<p>No summaries found.</p>";
          return;
        }

        const grouped = {};
        data.summaries.forEach(doc => {
          const key = doc.base_name || doc.input_data || "Unknown Source";
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(doc);
        });

        const groupArray = Object.keys(grouped).map(key => {
          const docs = grouped[key].sort((a, b) => getNumericTimestamp(b.timestamp) - getNumericTimestamp(a.timestamp));
          return { groupKey: key, docs, latestTimestamp: getNumericTimestamp(docs[0].timestamp) };
        });

        groupArray.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        groupedSummaries = groupArray;

        populateDropdown(groupArray);
        displayAccordion(groupArray);
      } catch (err) {
        console.error("Fetch error:", err);
        document.getElementById("accordion-container").innerHTML = "<p>Error loading summaries.</p>";
      }
    }

    window.onload = fetchSummaries;
  </script>
</body>
</html>
